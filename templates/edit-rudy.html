<script type="text/javascript" src="/js/processing-1.3.6.js"></script>
<script type="text/javascript" src="/js/jslint.js"></script>
<script type="text/javascript" src="/js/evaluator.js"></script>
<script type="text/javascript" src="/js/main.js"></script>
<script type="text/javascript" src="/js/rudy-wrapper.js"></script>
<script type="text/javascript" src="/socket.io/socket.io.js"></script>
<script type="text/javascript" src="/js/jsparse/lexer.js"></script>
<script type="text/javascript" src="/js/jsparse/parserlib.js"></script>
<script type="text/javascript" src="/js/jsparse/stringify.js"></script>
<script type="text/javascript" src="/js/jsparse/parser.js"></script>


<script type="text/javascript">
  window.Main = Em.Application.create({
    controller: CodingSupport.CodeController.create({
      codeTemplate: '<%= template %>',
      sketchId: '<%= sketchId %>',
      clientId: '<%= clientId %>',
      
      level: <%= extra ? extra.level : 1 %>,
      maxLevel: <%= extra ? extra.maxLevel : 1 %>,
      runtimeErrorHandler: function(errorObject) {
        this.get('codeMirrorView').markErrors([{
          line: errorObject.line,
          character: errorObject.char,
          reason: errorObject.msg
        }]);
      },
      
      extra: function() {
        return {level: this.get('level'), maxLevel: this.get('maxLevel')};
      }.property('level', 'maxLevel'),
      
      levelUnlockHandler: function(newLevel) {
        if (this.get('maxLevel') < newLevel) {
          this.set('maxLevel', newLevel);
          this.noteCodeChange();
        }
      },
      setLevel: function(newLevel) {
        if (newLevel <= this.get('maxLevel') && newLevel > 0) {
          this.set('level', newLevel);
          this.noteCodeChange();
        }
      },

      showInitialState: function() {
        window.ProcessingWrapper.executeCode("", this);
      }.observes('level'),
      
      resizeSidebar: function() {
        var winHeight = window.innerHeight || (document.documentElement || document.body).clientHeight;
        document.getElementById('pjs-wrapper').style.height = (winHeight - 60) + "px";
      },
      
      play: function() {
        document.getElementById('pjs-wrapper').scrollTop = 0;
        this._super();
      }
    }),
    ToolbarView: Em.View.extend({
      play: function() {
        this.get('controller').play();
      },
      parse: function() {
        this.get('controller').parse();
      },
      advanceLevel: function() {
        this.get('controller').setLevel(this.get('controller.level')+1);
      },
      revertLevel: function() {
        this.get('controller').setLevel(this.get('controller.level')-1);
      },
      canAdvance: function() {
        return this.get('controller.level') < this.get('controller.maxLevel');
      }.property('controller.level', 'controller.maxLevel'),
      canRevert: function() {
        return this.get('controller.level') > 1;
      }.property('controller.level'),
      revertStyle: function() {
        return this.get('canRevert') ? "font-size: 10px;" : "font-size: 10px; visibility: hidden;";
      }.property('canRevert')
    }),
    NotifyOnLoadView: Em.View.extend({
      didInsertElement: function() {
        this.get('target')[this.get('action')]();
      }
    })
  });

  $(function() {
    document.onkeypress = function(e) {
      if ((e.ctrlKey || e.metaKey) && e.keyCode == 114) { // Ctrl-R
        e.preventDefault();
        window.Main.controller.play();
      }
    }
  });
</script>

<script type="text/javascript">
  $(window).resize(Main.controller.resizeSidebar);
  // setTimeout(resizeSidebar, 100);
</script>

<script type="text/x-handlebars" date-template-name="application">
  <div id="toolbar">
    {{#view Main.ToolbarView controllerBinding="Main.controller"}}
      <div class="pull-right" style="padding-top: 5px;"><span class="label" {{bindAttr class="statusLabel.c" }}> {{statusLabel.l}}</span></div>
      <button class="btn btn-primary" {{action "play"}}><i class="icon-play icon-white"></i> Run</button>
      <button class="btn btn-info" {{action "parse"}}><i class="icon-white icon-leaf"></i> Parse</button>
      <span style="display: inline-block; padding-left: 30px">
        <span {{bindAttr style="view.revertStyle"}}><a href="#" {{action "revertLevel"}}>&laquo; go back</a></span>
        <span style="padding-left: 10px; padding-right: 10px;">Level: <strong>{{level}}</strong></span>
        {{#if view.canAdvance}}<button class="btn btn-mini btn-success" {{action "advanceLevel"}}>Advance ➙</button>{{/if}} </span>
    {{/view}}
  </div>
  <div id="pjs-wrapper" class="pull-right" style="width: 360px; padding-left: 10px; overflow: scroll;">
    <canvas id="pjs"></canvas>
    {{view Main.NotifyOnLoadView targetBinding="Main.controller" action="resizeSidebar"}}
    <h3>Programming Syntax Cheat Sheet</h3>
    <h4>Naming &amp; updating</h4>
    <p>Create a new name:
      <pre style="color: #d14;">var numberOfDots = 1;</pre>
    </p>
    <p>Update a name’s value:
      <pre style="color: #d14;">numberOfDots = numberOfDots + 1;</pre>
      This line computes the value of <em>numberOfDots&nbsp;+&nbsp;1</em>, and stores the new value in <em>numberOfDots</em>.
    </p>

    <h4>If, else</h4>
    <p>Run some code if a condition is true:
      <pre style="color: #d14">if (coloring() == 'blue') {
  right();
} else {
  left();
}</pre>
This code tells Rudy to go right if the current color is blue, and left otherwise. The <em>else { ... }</em> clause is optional.</p>

    <h4>While</h4>
    <p>Repeat some code as long as a condition is true:
      <pre style="color: #d14;">while (coloring() == 'blue') {
  down();
}</pre>
This code tells Rudy to go down as long as the square Rudy is currently on is blue.</p>

    <h4>Functions</h4>
    <p>To execute the <em>repeat</em> function:
      <pre style="color: #d14;">repeat(5, down);</pre>
      This function <em>repeat</em> is executed with two parameters: the number <em>5</em> and the function <em>down</em>.
    </p>
    <p>To define the <em>repeat</em> function:
      <pre style="color: #d14;">function repeat(n, direction) {
  while (n > 0) {
    n = n - 1;
    direction();
  }
}</pre>
The previous example, <code>repeat(5, down)</code>, sets <code>n = 5</code> and <code>direction = down</code> inside the body of the <em>repeat</em> function.
    </p>
  </div>
  <div style="margin-right: 370px;">
    {{#view CodingSupport.CodeMirrorView autoResize=true controllerBinding="Main.controller"}}<%- initialCode %>{{/view}}
  </div>
</script>

<script>
$(function() {
  var socket = io.connect();
  socket.on('connect', function() {
    socket.emit('register', {id: Main.controller.get('clientId')});
  });
  socket.on('runtime error', function(data) {
    console.log("runtime error!", data);
    Main.controller.get('codeMirrorView').markErrors([
      { line: data.line, character: data.char, reason: data.msg }
    ]);
  });
});
</script>

<canvas id="testcanvas" style="display: none;"></canvas>